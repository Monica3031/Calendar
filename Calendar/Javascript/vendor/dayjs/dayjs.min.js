// Tiny dayjs-compatible shim (minimal) used by this project when full dayjs
// is not available. Implements dayjs(), dayjs().day(), startOf, add, subtract,
// format (simple), diff (days), isSame/isAfter/isBefore, isValid, extend.
(function(global){
  function Day(d){
    this._date = d instanceof Date ? new Date(d.getTime()) : (typeof d === 'string' ? new Date(d) : (d && d._date ? new Date(d._date) : new Date()));
  }
  Day.prototype.isValid = function(){ return !isNaN(this._date.getTime()); };
  Day.prototype.day = function(){ return this._date.getDay(); };
  Day.prototype.startOf = function(unit){
    const d = new Date(this._date.getTime());
    if (unit === 'day') { d.setHours(0,0,0,0); return new Day(d); }
    if (unit === 'week') { d.setHours(0,0,0,0); d.setDate(d.getDate() - d.getDay()); return new Day(d); }
    return new Day(d);
  };
  Day.prototype.add = function(n, unit){ const d = new Date(this._date.getTime()); if (unit === 'day' || unit === 'days') d.setDate(d.getDate()+n); return new Day(d); };
  Day.prototype.subtract = function(n, unit){ return this.add(-n, unit); };
  Day.prototype.format = function(fmt){
  // Generic token-based formatter to cover app needs: YYYY, MMMM, MMM, MM, DD, D, dddd, ddd
  if (!fmt) return this._date.toString();
  const pad = (v)=>String(v).padStart(2,'0');
  const Y = this._date.getFullYear();
  const M = this._date.getMonth()+1; const D = this._date.getDate();
  const monthsShort = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthsLong = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const weekdaysShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const weekdaysLong = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    // Replace tokens using a single regex to avoid partial replacements
    const tokenMap = {
      'YYYY': Y,
      'MMMM': monthsLong[this._date.getMonth()],
      'dddd': weekdaysLong[this._date.getDay()],
      'ddd': weekdaysShort[this._date.getDay()],
      'MMM': monthsShort[this._date.getMonth()],
      'MM': pad(M),
      'DD': pad(D),
      'D': D
    };
    return String(fmt).replace(/YYYY|MMMM|dddd|ddd|MMM|MM|DD|D/g, (match) => tokenMap[match] ?? match);
  };
  Day.prototype.diff = function(other, unit){
    const ms = this._date.getTime() - (other._date ? other._date.getTime() : new Date(other).getTime());
    if (unit === 'day') return Math.floor(ms / (24*3600*1000));
    return ms;
  };
  Day.prototype.isSame = function(other, unit){ if (unit === 'day') return this.format('YYYY-MM-DD') === dayjs(other).format('YYYY-MM-DD'); return this._date.getTime() === dayjs(other)._date.getTime(); };
  Day.prototype.isAfter = function(other, unit){ return this._date.getTime() > dayjs(other)._date.getTime(); };
  Day.prototype.isBefore = function(other, unit){ return this._date.getTime() < dayjs(other)._date.getTime(); };
  Day.prototype.toDate = function(){ return new Date(this._date.getTime()); };
  Day.prototype._shortMonth = function(){ return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][this._date.getMonth()]; };
  Day.prototype._longMonth = function(){ return ['January','February','March','April','May','June','July','August','September','October','November','December'][this._date.getMonth()]; };
  Day.prototype._longWeekday = function(){ return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][this._date.getDay()]; };

  function dayjs(input, fmt){ if (input instanceof Day) return input; if (typeof input === 'string' && fmt) { // try parse simple YYYY-MM-DD
      if (fmt === 'YYYY-MM-DD') { const parts = input.split('-'); return new Day(new Date(parts[0], Number(parts[1])-1, parts[2])); }
    }
    return new Day(input);
  }
  dayjs.extend = function(){};
  global.dayjs = dayjs;
})(window);

